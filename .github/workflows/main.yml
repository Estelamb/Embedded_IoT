name: Cppcheck, Valgrind and Doxygen

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  cppcheck:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Install cppcheck
        run: sudo apt-get update && sudo apt-get install -y cppcheck

      - name: Run cppcheck
        run: |
          if [ -d "plant_monitoring_system" ]; then
            cd plant_monitoring_system
          fi
          echo "Running cppcheck in $(pwd)"
          cppcheck --enable=all --inconclusive --std=c++17 -I include src

  build:
    runs-on: ubuntu-latest
    needs: cppcheck
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Install build essentials and Linux headers
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libc6-dev linux-libc-dev gcc-multilib g++-multilib

      - name: Install Zephyr dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            git cmake ninja-build gperf ccache dfu-util device-tree-compiler wget \
            python3-dev python3-pip python3-setuptools python3-tk python3-wheel xz-utils file make gcc g++

      - name: Install west (Zephyr tool)
        run: |
          pip3 install --upgrade pip
          pip3 install west

      - name: Setup Zephyr workspace
        run: |
          mkdir zephyrproject
          cd zephyrproject
          west init -m https://github.com/zephyrproject-rtos/zephyr.git
          west update
          west zephyr-export
          pip3 install -r zephyr/scripts/requirements.txt
          mkdir app
          cp -r ../plant_monitoring_system/* app/
          cd app
          export ZEPHYR_TOOLCHAIN_VARIANT=host
          cp confs/prj_nucleo_wl55jc.conf prj.conf || echo "Using default config"
          west build -b native_sim .

  valgrind:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Install Valgrind
        run: sudo apt-get update && sudo apt-get install -y valgrind

      - name: Run Valgrind
        run: |
          cd plant_monitoring_system/build
          valgrind --leak-check=full ./zephyr/zephyr.elf || true
          cd ../..

  doxygen:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Install Doxygen
        run: sudo apt-get update && sudo apt-get install -y doxygen

      - name: Generate documentation for plant_monitoring_system
        run: |
          cd plant_monitoring_system
          doxygen Doxyfile

      - name: Verify HTML documentation output
        run: |
          ls -la ./plant_monitoring_system/docs/
          ls -la ./plant_monitoring_system/docs/html

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./plant_monitoring_system/docs/html
